<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LLM Prompt Tester</title>
</head>
<body>
  <h1>LLM Prompt Tester</h1>

  <label for="provider">Choose a provider:</label>
  <select id="provider">
    <option value="openai">OpenAI</option>
    <option value="anthropic">Anthropic</option>
    <option value="mistral">Mistral</option>
    <option value="together">Together.ai</option>
  </select>

  <div id="usage-warning" style="margin-top: 10px; font-weight: bold;"></div>

  <br /><br />

  <textarea id="prompt" rows="6" cols="60" placeholder="Enter your prompt here..."></textarea><br/>
  <button onclick="sendPrompt()">Submit</button>

  <h3>Response:</h3>
  <textarea id="response" rows="4" cols="60" readonly style="resize: vertical;"></textarea><br/>
  <button onclick="resetFields()">Reset</button>

  <script>
    const apiBase = "https://api.chaudhurisolutions.com";
    const token = "llm-secret-gooboy-smithie-2019";

    async function sendPrompt() {
      const prompt = document.getElementById("prompt").value;
      const provider = document.getElementById("provider").value;
      const responseEl = document.getElementById("response");
      responseEl.value = "Loading...";
      responseEl.style.height = "auto";

      try {
        const res = await fetch(`${apiBase}/prompt`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ prompt, provider })
        });

        const data = await res.json();
        const message = data.output || "No response.";
        responseEl.value = message;
        responseEl.style.height = "auto";
        responseEl.style.height = responseEl.scrollHeight + "px";
        updateUsageWarnings(); // refresh usage after each call
      } catch (err) {
        responseEl.value = "Error: " + err.message;
        responseEl.style.height = "auto";
        responseEl.style.height = responseEl.scrollHeight + "px";
      }
    }

    function resetFields() {
      document.getElementById("prompt").value = "";
      const responseEl = document.getElementById("response");
      responseEl.value = "";
      responseEl.style.height = "auto";
      document.getElementById("prompt").focus();
    }

    async function updateUsageWarnings() {
      const provider = document.getElementById("provider").value;
      const warningDiv = document.getElementById("usage-warning");
      warningDiv.textContent = "";

      try {
        const [usageRes, quotaRes] = await Promise.all([
          fetch(`${apiBase}/usage`, {
            headers: { Authorization: `Bearer ${token}` }
          }),
          fetch(`${apiBase}/quotas`, {
            headers: { Authorization: `Bearer ${token}` }
          })
        ]);

        const usageData = await usageRes.json();
        const quotaData = await quotaRes.json();

        const today = new Date().toISOString().slice(0, 10);
        const used = usageData.usage?.[today]?.[provider] || 0;
        const limit = quotaData.quotas?.[provider] || null;

        if (limit && used >= limit * 0.8) {
          warningDiv.textContent = `⚠️ ${provider} usage is at ${used}/${limit} (${Math.round((used / limit) * 100)}%)`;
          warningDiv.style.color = "red";
        } else if (limit) {
          warningDiv.textContent = `${provider} usage: ${used}/${limit}`;
          warningDiv.style.color = "gray";
        }

      } catch (err) {
        warningDiv.textContent = "⚠️ Usage info unavailable.";
        warningDiv.style.color = "orange";
      }
    }

    window.onload = () => {
      updateUsageWarnings();
      document.getElementById("provider").addEventListener("change", updateUsageWarnings);
    };
  </script>
</body>
</html>
