<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LLM Prompt Tester</title>
</head>
<body>
  <h1>LLM Prompt Tester</h1>

  <label for="provider">Choose a provider:</label>
  <select id="provider">
    <option value="openai">OpenAI</option>
    <option value="anthropic">Anthropic</option>
    <option value="mistral">Mistral</option>
    <option value="together">Together.ai</option>
    <option value="deepseek">DeepSeek</option>
  </select>

  <br /><br />

  <textarea id="prompt" rows="6" cols="60" placeholder="Enter your prompt here..."></textarea><br/>
  <button onclick="sendPrompt()">Submit</button>

  <h3>Response:</h3>
  <textarea id="response" rows="4" cols="60" readonly style="resize: vertical;"></textarea><br/>
  <button onclick="resetFields()">Reset</button>

  <h3>Usage Summary:</h3>
  <div id="usage-summary" style="font-family: monospace; white-space: pre-line;"></div>

  <script>
    const apiBase = "https://api.chaudhurisolutions.com";
    const token = "llm-secret-gooboy-smithie-2019";

    async function sendPrompt() {
      const prompt = document.getElementById("prompt").value;
      const provider = document.getElementById("provider").value;
      const responseEl = document.getElementById("response");
      responseEl.value = "Loading...";
      responseEl.style.height = "auto";

      try {
        const res = await fetch(`${apiBase}/prompt`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ prompt, provider })
        });

        const data = await res.json();
        const message = data.output || "No response.";
        responseEl.value = message;
        responseEl.style.height = "auto";
        responseEl.style.height = responseEl.scrollHeight + "px";

        updateUsageDashboard(); // refresh usage after submission
      } catch (err) {
        responseEl.value = "Error: " + err.message;
        responseEl.style.height = "auto";
        responseEl.style.height = responseEl.scrollHeight + "px";
      }
    }

    function resetFields() {
      document.getElementById("prompt").value = "";
      const responseEl = document.getElementById("response");
      responseEl.value = "";
      responseEl.style.height = "auto";
      document.getElementById("prompt").focus();
    }

    async function updateUsageDashboard() {
      const dashboard = document.getElementById("usage-summary");
      dashboard.textContent = "Loading usage data...";

      try {
        const [usageRes, quotaRes] = await Promise.all([
          fetch(`${apiBase}/usage`, {
            headers: { Authorization: `Bearer ${token}` }
          }),
          fetch(`${apiBase}/quotas`, {
            headers: { Authorization: `Bearer ${token}` }
          })
        ]);

        const usageData = await usageRes.json();
        const quotaData = await quotaRes.json();

        const today = new Date().toISOString().slice(0, 10);
        const usage = usageData.usage?.[today] || {};
        const quotas = quotaData.quotas || {};

        const providerNames = {
          openai: "ðŸ§  OpenAI",
          anthropic: "ðŸ¤– Anthropic",
          mistral: "âš¡ Mistral",
          together: "ðŸ” Together.ai"
        };

        let output = "";
        let total = 0;

        for (const provider of Object.keys(providerNames)) {
          const used = usage[provider] || 0;
          const limit = quotas[provider] || "N/A";
          const emoji = providerNames[provider];
          const plural = used === 1 ? "" : "s";

          output += `${emoji} â€” ${used} / ${limit} request${plural}\n`;
          if (limit !== "N/A" && used >= limit * 0.8) {
            output += `âš ï¸  ${provider} usage is at ${used}/${limit} (${Math.round((used / limit) * 100)}%)\n`;
          }

          if (typeof used === "number") total += used;
        }

        output += `\nðŸ§¾ Total requests today: ${total}`;
        dashboard.textContent = output;

      } catch (err) {
        dashboard.textContent = "âš ï¸ Could not load usage data.";
      }
    }

    window.onload = () => {
      updateUsageDashboard();
    };
  </script>
</body>
</html>
